#!/bin/bash

EXPERIMENT_PURPOSE="std0_bias0_1" # <--- ä½ çš„æ–°å¢žå˜é‡
LOCAL_BASE_STAGING_DIR="./temp1" # <--- ä½ ä¿®æ”¹çš„æœ¬åœ°æš‚å­˜ç›®å½•å

GDRIVE_TARGET_BASE_PATH="google-drive:auto_sync/${EXPERIMENT_PURPOSE}" 

mkdir -p "${LOCAL_BASE_STAGING_DIR}"

for seed in 3047 114514 666 65536 4999; do
    echo "======================================================"
    echo "ðŸŒ± Running experiment for seed: ${seed} (Purpose: ${EXPERIMENT_PURPOSE})" # å¯ä»¥åœ¨æ—¥å¿—ä¸­åŠ å…¥ç›®çš„
    echo "======================================================"

    CURRENT_SEED_LOCAL_OUTPUT_DIR="${LOCAL_BASE_STAGING_DIR}/seed_${seed}_outputs"
    mkdir -p "${CURRENT_SEED_LOCAL_OUTPUT_DIR}"
    echo "Local staging directory for this seed: ${CURRENT_SEED_LOCAL_OUTPUT_DIR}"

    echo "Starting Python experiment script..."
    ./run_experiment_queue.py \
        -okbe \
        --nohup \
        --queue sdp ltidl ltari e2e \
        --seed "$seed" \
        --google-drive-path "${CURRENT_SEED_LOCAL_OUTPUT_DIR}"
    script_exit_code=$?

    if [ ${script_exit_code} -eq 0 ]; then
        echo "âœ… Experiment for seed ${seed} completed successfully."
        GDRIVE_SEED_TARGET_PATH="${GDRIVE_TARGET_BASE_PATH}/experiment_seed_${seed}"
        echo "â˜ï¸ Syncing results from ${CURRENT_SEED_LOCAL_OUTPUT_DIR} to ${GDRIVE_SEED_TARGET_PATH}"

        rclone sync "${CURRENT_SEED_LOCAL_OUTPUT_DIR}" "${GDRIVE_SEED_TARGET_PATH}" --progress
        
        if [ $? -eq 0 ]; then
            echo "ðŸ‘ Sync for seed ${seed} to Google Drive completed successfully."
        else
            echo "âš ï¸ Sync for seed ${seed} to Google Drive failed."
        fi
    else
        echo "âŒ Experiment for seed ${seed} failed with exit code ${script_exit_code}. Skipping sync."
    fi
    echo "------------------------------------------------------"
    echo ""
done

echo "ðŸŽ‰ All experiments in the loop for purpose '${EXPERIMENT_PURPOSE}' have been processed."

# è‡ªåŠ¨åˆ é™¤æœ¬åœ°çš„ä¸­è½¬åŸºç¡€è¾“å‡ºç›®å½•
if [ -d "${LOCAL_BASE_STAGING_DIR}" ]; then
    echo "ðŸ—‘ï¸ Automatically deleting the local staging directory: ${LOCAL_BASE_STAGING_DIR}"
    rm -rf "${LOCAL_BASE_STAGING_DIR}"
    if [ $? -eq 0 ]; then
        echo "âœ… Local staging directory ${LOCAL_BASE_STAGING_DIR} deleted successfully."
    else
        echo "âš ï¸ Failed to delete local staging directory ${LOCAL_BASE_STAGING_DIR}."
    fi
else
    echo "â„¹ï¸ Local staging directory ${LOCAL_BASE_STAGING_DIR} not found or is not a directory, skipping deletion."
fi