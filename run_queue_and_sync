#!/bin/bash

EXPERIMENT_PURPOSE="std0_bias0_1"             # æ–°å¢å˜é‡ï¼Œå®éªŒç”¨é€”
LOCAL_BASE_STAGING_DIR="./temp1"              # æœ¬åœ°æš‚å­˜ç›®å½•
GDRIVE_TARGET_BASE_PATH="google-drive:auto_sync/${EXPERIMENT_PURPOSE}"

mkdir -p "${LOCAL_BASE_STAGING_DIR}"

for seed in 3047 114514 65536 4999; do
    echo "======================================================"
    echo "ğŸŒ± Running experiment for seed: ${seed} (Purpose: ${EXPERIMENT_PURPOSE})"
    echo "======================================================"

    # å°†è¾“å‡ºæ”¾åœ¨ experiment_seed_<seed> ç›®å½•å†…ï¼Œä¾¿äºä¿æŒè¿œç«¯ç»“æ„ä¸€è‡´
    CURRENT_SEED_LOCAL_OUTPUT_DIR="${LOCAL_BASE_STAGING_DIR}/experiment_seed_${seed}"
    mkdir -p "${CURRENT_SEED_LOCAL_OUTPUT_DIR}"
    echo "Local staging directory for this seed: ${CURRENT_SEED_LOCAL_OUTPUT_DIR}"

    echo "Starting Python experiment script..."
    ./run_experiment_queue.py \
        -okbe \
        --nohup \
        --queue sdp ltidl ltari e2e \
        --seed "$seed" \
        --google-drive-path "${CURRENT_SEED_LOCAL_OUTPUT_DIR}"
    script_exit_code=$?

    if [ ${script_exit_code} -eq 0 ]; then
        echo "âœ… Experiment for seed ${seed} completed successfully."
    else
        echo "âŒ Experiment for seed ${seed} failed with exit code ${script_exit_code}."
    fi
    echo "------------------------------------------------------"
    echo ""
done

echo "â˜ï¸ Syncing ALL results in ${LOCAL_BASE_STAGING_DIR} to ${GDRIVE_TARGET_BASE_PATH}"
rclone sync "${LOCAL_BASE_STAGING_DIR}" "${GDRIVE_TARGET_BASE_PATH}" --progress
sync_exit_code=$?

if [ ${sync_exit_code} -eq 0 ]; then
    echo "ğŸ‘ Global sync completed successfully."

    # åŒæ­¥æˆåŠŸååˆ é™¤æœ¬åœ°æš‚å­˜ç›®å½•
    if [ -d "${LOCAL_BASE_STAGING_DIR}" ]; then
        echo "ğŸ—‘ï¸ Deleting local staging directory: ${LOCAL_BASE_STAGING_DIR}"
        rm -rf "${LOCAL_BASE_STAGING_DIR}"
        if [ $? -eq 0 ]; then
            echo "âœ… Local staging directory deleted successfully."
        else
            echo "âš ï¸ Failed to delete local staging directory."
        fi
    fi
else
    echo "âš ï¸ Global sync failed. Local files are kept at ${LOCAL_BASE_STAGING_DIR} for inspection."
fi

echo "ğŸ‰ All experiments for purpose '${EXPERIMENT_PURPOSE}' have been processed."
