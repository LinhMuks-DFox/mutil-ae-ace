#!/bin/bash

EXPERIMENT_PURPOSE="std_005_bias_01_new_autoencoder"
LOCAL_BASE_STAGING_DIR="./temp1"
GDRIVE_TARGET_BASE_PATH="google-drive:auto_sync/${EXPERIMENT_PURPOSE}"
MAX_JOBS=2  # æ–°å¢å˜é‡ï¼Œæ§åˆ¶æœ€å¤§å¹¶è¡Œä»»åŠ¡æ•°

mkdir -p "${LOCAL_BASE_STAGING_DIR}"

# å¾…å¤„ç†çš„ seed åˆ—è¡¨
SEEDS=(3047 114514 65536 4999)

# éå†æ‰€æœ‰ seedï¼Œå¯åŠ¨åå°ä»»åŠ¡
for seed in "${SEEDS[@]}"; do
    # ä½¿ç”¨å­ shell (...) & å°†æ¯ä¸ªå¾ªç¯çš„ä»»åŠ¡ä½œä¸ºä¸€ä¸ªæ•´ä½“åœ¨åå°è¿è¡Œ
    (
        echo "======================================================"
        echo "ğŸŒ± Starting experiment for seed: ${seed} (Purpose: ${EXPERIMENT_PURPOSE})"
        echo "======================================================"

        CURRENT_SEED_LOCAL_OUTPUT_DIR="${LOCAL_BASE_STAGING_DIR}/experiment_seed_${seed}"
        mkdir -p "${CURRENT_SEED_LOCAL_OUTPUT_DIR}"
        echo "Local staging directory for seed ${seed}: ${CURRENT_SEED_LOCAL_OUTPUT_DIR}"

        echo "Starting Python experiment script for seed ${seed}..."
        ./run_experiment_queue.py \
            -okbe \
            --nohup \
            --queue ltari \
            --seed "$seed" \
            --google-drive-path "${CURRENT_SEED_LOCAL_OUTPUT_DIR}"
        script_exit_code=$?

        if [ ${script_exit_code} -eq 0 ]; then
            echo "âœ… Experiment for seed ${seed} completed successfully."
        else
            echo "âŒ Experiment for seed ${seed} failed with exit code ${script_exit_code}."
        fi
        echo "------------------------------------------------------"
    ) & # å°†å­ shell æ”¾å…¥åå°æ‰§è¡Œ

    # æ§åˆ¶å¹¶è¡Œä»»åŠ¡æ•°é‡
    # å½“åå°ä»»åŠ¡æ•°é‡è¾¾åˆ° MAX_JOBS æ—¶ï¼Œç­‰å¾…ä»»ä¸€ä»»åŠ¡å®Œæˆå†ç»§ç»­
    while [[ $(jobs -p | wc -l) -ge ${MAX_JOBS} ]]; do
        sleep 1
    done
done

# ç­‰å¾…æ‰€æœ‰åå°ä»»åŠ¡æ‰§è¡Œå®Œæ¯•
echo "â³ Waiting for all background experiments to complete..."
wait
echo "All experiments have finished."
echo ""

# æ‰€æœ‰å®éªŒå®Œæˆåï¼Œå¼€å§‹åŒæ­¥
echo "â˜ï¸ Syncing ALL results in ${LOCAL_BASE_STAGING_DIR} to ${GDRIVE_TARGET_BASE_PATH}"
rclone sync "${LOCAL_BASE_STAGING_DIR}" "${GDRIVE_TARGET_BASE_PATH}" --progress
sync_exit_code=$?

if [ ${sync_exit_code} -eq 0 ]; then
    echo "ğŸ‘ Global sync completed successfully."

    if [ -d "${LOCAL_BASE_STAGING_DIR}" ]; then
        echo "ğŸ—‘ï¸ Deleting local staging directory: ${LOCAL_BASE_STAGING_DIR}"
        rm -rf "${LOCAL_BASE_STAGING_DIR}"
        if [ $? -eq 0 ]; then
            echo "âœ… Local staging directory deleted successfully."
        else
            echo "âš ï¸ Failed to delete local staging directory."
        fi
    fi
else
    echo "âš ï¸ Global sync failed. Local files are kept at ${LOCAL_BASE_STAGING_DIR} for inspection."
fi

echo "ğŸ‰ All experiments for purpose '${EXPERIMENT_PURPOSE}' have been processed."